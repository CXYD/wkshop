(function() {
    function a(a, d, b) {
        var e = document.createElement("canvas");
        c(a, e, d, b);
        return e.toDataURL("image/jpeg", d.quality || .8)
    }
    function c(a, d, b, c) {
        var f = a.naturalWidth, e = a.naturalHeight;
        if (f + e) {
            var k = b.width, p = b.height, h = d.getContext("2d");
            h.save();
            b = b.orientation;
            switch (b) {
                case 5:
                case 6:
                case 7:
                case 8:
                    d.width = p;
                    d.height = k;
                    break;
                default:
                    d.width = k, d.height = p
            }
            switch (b) {
                case 2:
                    h.translate(k, 0);
                    h.scale(-1, 1);
                    break;
                case 3:
                    h.translate(k, p);
                    h.rotate(Math.PI);
                    break;
                case 4:
                    h.translate(0, p);
                    h.scale(1, -1);
                    break;
                case 5:
                    h.rotate(.5 * Math.PI);
                    h.scale(1, -1);
                    break;
                case 6:
                    h.rotate(.5 * Math.PI);
                    h.translate(0, -p);
                    break;
                case 7:
                    h.rotate(.5 * Math.PI);
                    h.translate(k, -p);
                    h.scale(-1, 1);
                    break;
                case 8:
                    h.rotate(-.5 * Math.PI), h.translate(-k, 0)
            }
            d = a.naturalWidth;
            1048576 < d * a.naturalHeight ? (b = document.createElement("canvas"), b.width = b.height = 1, b = b.getContext("2d"), b.drawImage(a, -d + 1, 0), d = 0 === b.getImageData(0, 0, 1, 1).data[3]) : d = !1;
            d && (f /= 2, e /= 2);
            d = document.createElement("canvas");
            d.width = d.height = 1024;
            b = d.getContext("2d");
            if (c) {
                c = e;
                var l = document.createElement("canvas");
                l.width = 1;
                l.height = c;
                l = l.getContext("2d");
                l.drawImage(a, 0, 0);
                for (var l = l.getImageData(0, 0, 1, c).data, q = 0, r = c, v = c; v > q; )
                    0 === l[4 * (v - 1) + 3] ? r = v : q = v, v = r + q >> 1;
                c = v / c;
                c = 0 === c ? 1 : c
            } else
                c = 1;
            k = Math.ceil(1024 * k / f);
            p = Math.ceil(1024 * p / e / c);
            for (l = c = 0; c < e; ) {
                for (r = q = 0; q < f; )
                    b.clearRect(0, 0, 1024, 1024), b.drawImage(a, -q, -c), h.drawImage(d, 0, 0, 1024, 1024, r, l, k, p), q += 1024, r += k;
                c += 1024;
                l += p
            }
            h.restore()
        }
    }
    function b(a) {
        if (window.Blob && a instanceof Blob) {
            if (!e)
                throw Error("No createObjectURL function found to create blob url");
            var b = new Image;
            b.src = e.createObjectURL(a);
            this.blob = a;
            a = b
        }
        if (!a.naturalWidth && !a.naturalHeight) {
            var c = this;
            a.onload = a.onerror = function() {
                var a = c.imageLoadListeners;
                if (a) {
                    c.imageLoadListeners = null;
                    for (var b = 0, d = a.length; b < d; b++)
                        a[b]()
                }
            };
            this.imageLoadListeners = []
        }
        this.srcImage = a
    }
    var e = window.URL && window.URL.createObjectURL ? window.URL : window.webkitURL && window.webkitURL.createObjectURL ? window.webkitURL : null;
    b.prototype.render = function(b, d, m) {
        if (this.imageLoadListeners) {
            var t = this;
            this.imageLoadListeners.push(function() {
                t.render(b, 
                d, m)
            })
        } else {
            d = d || {};
            var f = this.srcImage.naturalWidth, g = this.srcImage.naturalHeight, k = d.width, p = d.height, h = d.maxWidth, l = d.maxHeight, q = !this.blob || "image/jpeg" === this.blob.type;
            k && !p ? p = g * k / f << 0 : p && !k ? k = f * p / g << 0 : (k = f, p = g);
            h && k > h && (k = h, p = g * k / f << 0);
            l && p > l && (p = l, k = f * p / g << 0);
            var f = {width: k,height: p}, r;
            for (r in d)
                f[r] = d[r];
            r = b.tagName.toLowerCase();
            "img" === r ? b.src = a(this.srcImage, f, q) : "canvas" === r && c(this.srcImage, b, f, q);
            if ("function" === typeof this.onrender)
                this.onrender(b);
            m && m();
            this.blob && (this.blob = null, 
            e.revokeObjectURL(this.srcImage.src))
        }
    };
    "function" === typeof define && define.amd ? define([], function() {
        return b
    }) : this.MegaPixImage = b
})();
jQuery.extend({createUploadIframe: function(a, c) {
        var b = "jUploadFrame" + a, e;
        try {
            e = document.createElement('<iframe name="' + b + '">')
        } catch (n) {
            e = document.createElement("iframe")
        }
        e.name = b;
        e.id = b;
        e.style.display = "none";
        jQuery(e).appendTo(document.body);
        return jQuery("#" + b).get(0)
    },createUploadForm: function(a, c, b, e, n) {
        var d = "jUploadForm" + a;
        a = "jUploadFile" + a;
        d = jQuery('<form  action="" method="POST" name="' + d + '" id="' + d + '" enctype="multipart/form-data"></form>');
        if (b)
            for (var m in b)
                jQuery('<input type="hidden" name="' + 
                m + '" value="' + b[m] + '" />').appendTo(d);
        n || (c = null == e ? jQuery("#" + c) : e, b = jQuery(c).clone(!0), jQuery(c).attr("id", a), jQuery(c).before(b), jQuery(c).appendTo(d));
        jQuery(d).css("position", "absolute");
        jQuery(d).css("top", "-1200px");
        jQuery(d).css("left", "-1200px");
        jQuery(d).appendTo("body");
        return d
    },ajaxFileUpload: function(a) {
        a = jQuery.extend({}, jQuery.ajaxSettings, a);
        try {
            if (a.compress && window.applicationCache && a.uploadType && a.fileElementId && "" != a.fileElementId)
                if ("img" == a.uploadType) {
                    var c = document.getElementById(a.fileElementId);
                    if (c && "" != c.src) {
                        var b = "file:" + $(c).attr("path");
                        -1 == b.indexOf(".") && (b = "file:C:\fakepatherrorPath.jpg");
                        "undefined" == typeof a.data && (a.data = {});
                        jQuery.ajax({url: a.url.replace("&domain=bbn.com.cn", ""),data: {file_sign: "form",file_name: b,file_data: c.src},cache: !1,type: "POST",dataType: "json",success: a.success,error: a.error})
                    } else
                        a.compress = !1, jQuery.ajaxFileUpload_normal(a)
                } else if ("file" == a.uploadType) {
                    var e = document.getElementById(a.fileElementId);
                    e && e.files && 0 < e.files.length ? jQuery.compress(e, a.newWidth, 
                    a.newHeight, a.limitSize, a.limitWidth, function(b) {
                        b && b.value && "" != b.value ? ("undefined" == typeof a.data && (a.data = {}), a.data[b.script] = b.value) : a.compress = !1;
                        jQuery.ajaxFileUpload_normal(a)
                    }) : (a.compress = !1, jQuery.ajaxFileUpload_normal(a))
                } else
                    a.compress = !1, jQuery.ajaxFileUpload_normal(a);
            else
                a.compress = !1, jQuery.ajaxFileUpload_normal(a)
        } catch (n) {
            a.compress = !1, jQuery.ajaxFileUpload_normal(a)
        }
    },ajaxFileUpload_normal: function(a) {
        a = jQuery.extend({}, jQuery.ajaxSettings, a);
        var c = (new Date).getTime(), b = jQuery.createUploadForm(c, 
        a.fileElementId, "undefined" == typeof a.data ? !1 : a.data, a.fileElement, a.compress);
        jQuery.createUploadIframe(c, a.secureuri);
        var e = "jUploadFrame" + c, c = "jUploadForm" + c;
        a.global && !jQuery.active++ && jQuery.event.trigger("ajaxStart");
        var n = !1, d = {};
        a.global && jQuery.event.trigger("ajaxSend", [d, a]);
        var m = function(c) {
            var g = document.getElementById(e), k = !1;
            try {
                g.contentWindow ? (d.responseText = g.contentWindow.document.body ? g.contentWindow.document.body.innerHTML : null, d.responseXML = g.contentWindow.document.XMLDocument ? 
                g.contentWindow.document.XMLDocument : g.contentWindow.document) : g.contentDocument && (d.responseText = g.contentDocument.document.body ? g.contentDocument.document.body.innerHTML : null, d.responseXML = g.contentDocument.document.XMLDocument ? g.contentDocument.document.XMLDocument : g.contentDocument.document)
            } catch (m) {
                k = !0, jQuery.handleError(a, d, null, m)
            }
            if (!k && (d || "timeout" == c)) {
                n = !0;
                var h;
                try {
                    if (h = "timeout" != c ? "success" : "error", "error" != h) {
                        var l = jQuery.uploadHttpData(d, a.dataType);
                        "object" != typeof l && (l = jQuery.parseJSON(l));
                        a.success && a.success(l, h, a.compress, a.data);
                        a.global && jQuery.event.trigger("ajaxSuccess", [d, a])
                    } else
                        jQuery.handleError(a, d, h)
                } catch (q) {
                    h = "error", jQuery.handleError(a, d, h, q)
                }
                a.global && jQuery.event.trigger("ajaxComplete", [d, a]);
                a.global && !--jQuery.active && jQuery.event.trigger("ajaxStop");
                a.complete && a.complete(d, h);
                jQuery(g).unbind();
                setTimeout(function() {
                    try {
                        jQuery(g).remove(), jQuery(b).remove()
                    } catch (c) {
                        jQuery.handleError(a, d, null, c)
                    }
                }, 100);
                d = null
            }
        };
        0 < a.timeout && setTimeout(function() {
            n || m("timeout")
        }, 
        a.timeout);
        try {
            b = jQuery("#" + c), jQuery(b).attr("action", a.url), jQuery(b).attr("method", "POST"), jQuery(b).attr("target", e), b.encoding ? jQuery(b).attr("encoding", "multipart/form-data") : jQuery(b).attr("enctype", "multipart/form-data"), jQuery(b).submit()
        } catch (t) {
            jQuery.handleError(a, d, null, t)
        }
        jQuery("#" + e).load(m);
        return {abort: function() {
                try {
                    jQuery("#" + e).remove(), jQuery(b).remove()
                } catch (a) {
                }
            }}
    },compress: function(a, c, b, e, n, d) {
        var m = a.files, t = a.id || a.name, f = a.value;
        window.URL = window.URL || window.webkitURL;
        for (var g = 0; a = m[g]; g++) {
            var k = a.type, p = a.size;
            k && "" != k || (k = "image/jpeg");
            if (k.match("image.*")) {
                var h = new FileReader;
                h.onload = function(a) {
                    var q = new Image;
                    q.onload = function() {
                        var a = document.createElement("canvas"), l = 1;
                        e && 0 < e && p > e ? (l = Math.sqrt(e / p), a.width = this.width * l, a.height = this.height * l, n && (a.width > n || a.height > n) && (l = n / this.width, a.width = this.width * l, a.height = this.height * l)) : c && 0 < c && b && 0 < b ? (a.width = c, a.height = b) : (a.width = this.width * l, a.height = this.height * l);
                        var w = a.getContext("2d");
                        w.drawImage(this, 
                        0, 0, a.width, a.height);
                        var l = a.toDataURL(k, .9), u = {};
                        u.id = t;
                        u.script = "file:" + f;
                        u.position = g;
                        u.path = f;
                        u.type = k;
                        u.value = l;
                        d(u);
                        try {
                            setTimeOut(function() {
                                h = q = w = a = m = null;
                                delete q;
                                delete h
                            }, 1E3)
                        } catch (x) {
                        }
                    };
                    q.src = a.target.result
                };
                h.readAsDataURL(a)
            }
        }
    },pcPreView: function(a, c) {
        var b = document.getElementById(a);
        if ((window.URL || window.webkitURL) && b.files)
            window.URL = window.URL || window.webkitURL, c.src = window.URL.createObjectURL(b.files[0]);
        else if (window.FileReader)
            oFReader = new FileReader, oFReader.readAsDataURL(b.files[0]), 
            oFReader.onload = function(a) {
                c.src = a.target.result
            };
        else if (document.all) {
            b.select();
            var b = document.selection.createRange().text, e = navigator.appName, n = navigator.appVersion.split(";")[1].replace(/[ ]/g, "");
            "Microsoft Internet Explorer" == e && "MSIE6.0" == n ? c.src = b : "Microsoft Internet Explorer" == e && "MSIE7.0" == n ? (c.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src=\"" + b + '")', c.src = "http://lianmeng.wokuan.cn/Public/image/filter.png") : (c.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src=\"" +
            b + '")', c.src = "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==")
        } else
            b.files && b.files.item(0) && (url = b.files.item(0).getAsDataURL(), c.src = url)
    },preView: function(a, c, b) {
        window.URL = window.URL || window.webkitURL;
        if (window.FileReader || window.URL) {
            var e = a.target.files, n = a.target.value;
            a = 0;
            for (var d; d = e[a]; a++) {
                var m = d.type, t = d.size;
                m && "" != m || (m = "image/jpeg");
                if (m.match("image.*"))
                    if (window.URL)
                        try {
                            var f = $("#" + c);
                            f[0].onload = function() {
                                try {
                                    window.URL.revokeObjectURL(this.pic)
                                } catch (a) {
                                }
                            };
                            f.attr("src", window.URL.createObjectURL(d));
                            f.attr("size", t);
                            f.attr("path", n);
                            f.attr("type", m);
                            f.attr("isNew", "1");
                            b(!0);
                            break
                        } catch (g) {
                            b(!1);
                            break
                        }
                    else if (window.FileReader) {
                        var k = new FileReader;
                        k.onload = function(a) {
                            return function(a) {
                                var d = $("#" + c);
                                a.target.result ? (d.attr("src", a.target.result), d.attr("size", t), d.attr("path", n), d.attr("type", m), d.attr("isNew", "1"), b(!0)) : b(!1)
                            }
                        }(d);
                        k.readAsDataURL(d)
                    }
            }
        } else
            b(!1)
    },preViewImg: function(a, c, b, e) {
        try {
            var n = a.length, d = "image/" + b.substring(b.lastIndexOf(".") + 
            1), m = $("#" + c);
            m.attr("src", "data:" + d + ";base64," + a);
            m.attr("size", n);
            m.attr("path", b);
            m.attr("type", d);
            m.attr("isNew", "1");
            e(!0)
        } catch (t) {
            e(!1)
        }
    },preViewCompress: function(a, c, b, e) {
        var n = $(a);
        if ("1" == n.attr("isNew"))
            try {
                n.attr("isNew", "2"), (new MegaPixImage(a)).render(a, {width: b,height: 1.2 * b,quality: .9}, e)
            } catch (d) {
                var n = $(a), m = n.attr("size");
                n.attr("path");
                var t = n.attr("type"), f = document.createElement("canvas"), g = 1;
                c && 0 < c && m > c ? (g = Math.sqrt(c / m), f.width = a.width * g, f.height = a.height * g, b && (f.width > b || 
                f.height > b) && (g = b / a.width, f.width = a.width * g, f.height = a.height * g)) : b && (f.width > b || f.height > b) ? (g = b / a.width, f.width = a.width * g, f.height = a.height * g) : (f.width = a.width, f.height = a.height);
                f.getContext("2d").drawImage(a, 0, 0, f.width, f.height);
                n.attr("isNew", "2");
                n.attr("src", f.toDataURL(t, .9));
                e()
            }
    },uploadHttpData: function(a, c) {
        var b;
        b = "xml" != c && c ? a.responseText : a.responseXML;
        "script" == c && jQuery.globalEval(b);
        "json" == c && eval("data = " + b);
        "html" == c && jQuery("<div>").html(b).evalScripts();
        return b
    },handleError: function(a, 
    c, b, e) {
        a.error && a.error(c, b, e);
        a.global && jQuery.event.trigger("ajaxError", [c, a, e])
    }});
